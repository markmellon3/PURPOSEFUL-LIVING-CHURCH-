<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PLC Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-auth-compat.js"></script>

<style>
body{
  margin:0;
  padding:15px;
  font-family:Arial,Helvetica,sans-serif;
  background:#f2f2f2;
}

.panel{
  max-width:900px;
  margin:20px auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.12);
}

h2{ color:#ff6600; margin-top:0; }

input, textarea, button{
  width:100%;
  padding:10px;
  margin-top:10px;
  box-sizing:border-box;
  font-size:16px;
}

textarea{ min-height:120px; }

button{
  background:#ff6600;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}

button:hover{ background:#e65c00; }

hr{ margin:30px 0; }

.item{
  background:#fafafa;
  border:1px solid #ddd;
  border-radius:8px;
  padding:15px;
  margin-bottom:15px;
}

.item img{
  width:100%;
  border-radius:8px;
}

.actions{
  margin-top:10px;
}

.actions button{
  width:auto;
  padding:6px 12px;
  margin-right:5px;
  font-size:14px;
}

.edit{ background:#007bff; }
.edit:hover{ background:#0056b3; }

.delete{ background:#dc3545; }
.delete:hover{ background:#a71d2a; }

@media(max-width:600px){
  body{ padding:10px; }
  .panel{ padding:15px; }
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="panel" id="loginPanel">
  <h2>Admin Login</h2>
  <input type="email" id="email" placeholder="Admin Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- ADMIN DASHBOARD -->
<div class="panel" id="adminPanel" style="display:none;">
  
  <hr>

<h2>Live Website Preview</h2>
<p>You can see your website changes in real-time here:</p>
<button onclick="refreshPreview()">Refresh Preview</button>
<div style="margin-top:10px; border:1px solid #ccc; border-radius:8px; overflow:hidden;">
  <iframe id="livePreview" src="https://purposefullivingchurchplc.org/" style="width:100%; height:600px; border:none;"></iframe>
</div>

  <h2>Add / Edit News</h2>
  <input type="hidden" id="newsId">
  <input id="title" placeholder="News Title">
  <input type="date" id="date">
  <textarea id="content" placeholder="News Content"></textarea>
  <button onclick="saveNews()">Save News</button>

  <hr>

  <h2>All News (Recent & Old)</h2>
  <div id="newsList"></div>

  <hr>

  <h2>Add Event Image</h2>
  <input id="imageUrl" placeholder="Image URL">
  <button onclick="addEvent()">Add Event Image</button>

  <hr>

  <h2>Manage Event Images</h2>
  <div id="eventList"></div>

  <hr>

  <h2>Manage Media Images</h2>
  <h3>Add Media Image</h3>
  <input id="mediaUrl" placeholder="Media Image URL">
  <button onclick="addMediaImage()">Add Media Image</button>

  <h3>All Media Images</h3>
  <div id="mediaList"></div>
  
</div>

<script>
/* ---------- FIREBASE CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDaFhZ_ykNSmNXKCh6ye1M1vgoW6VhrdLU",
  authDomain: "plc-church.firebaseapp.com",
  databaseURL: "https://plc-church-default-rtdb.firebaseio.com",
  projectId: "plc-church"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* ---------- AUTH ---------- */
function login(){
  auth.signInWithEmailAndPassword(email.value, password.value)
    .then(() => {
      loginPanel.style.display = "none";
      adminPanel.style.display = "block";
      loadNews();
      loadEvents();
      loadMediaImages();
    })
    .catch(err => alert(err.message));
}

/* ---------- NEWS CRUD ---------- */
function saveNews(){
  const data = {
    title: title.value || "",
    date: date.value || "",
    content: content.value || ""
  };

  if(newsId.value){
    db.ref("news/" + newsId.value).update(data);
  } else {
    data.views = 0;
    db.ref("news").push(data);
  }

  newsId.value = "";
  title.value = "";
  date.value = "";
  content.value = "";
}

// FIXED: LOAD ALL NEWS RECENT FIRST
function loadNews(){
  db.ref("news").on("value", snap => {
    const list = document.getElementById("newsList");
    list.innerHTML = "";

    const newsArray = [];
    snap.forEach(child => {
      const n = { id: child.key, ...child.val() };
      // Convert date to timestamp for sorting; if missing, treat as 0
      n.timestamp = n.date ? new Date(n.date).getTime() : 0;
      newsArray.push(n);
    });

    // Sort descending (newest first)
    newsArray.sort((a,b) => b.timestamp - a.timestamp);

    newsArray.forEach(n=>{
      list.innerHTML += `
        <div class="item">
          <strong>${n.title || "Untitled News"}</strong><br>
          <small>${n.date || "No date"} ‚Ä¢ üëÅ ${n.views || 0} views</small>
          <p>${n.content || ""}</p>
          <div class="actions">
            <button class="edit"
              onclick="editNews(
                '${n.id}',
                '${(n.title||"").replace(/'/g,"\\'")}',
                '${n.date||""}',
                '${(n.content||"").replace(/'/g,"\\'")}'
              )">Edit</button>
            <button class="delete"
              onclick="deleteNews('${n.id}')">Delete</button>
          </div>
        </div>`;
    });
  });
}

function editNews(id, t, d, c){
  newsId.value = id;
  title.value = t;
  date.value = d;
  content.value = c;
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function deleteNews(id){
  if(confirm("Delete this news?")){
    db.ref("news/" + id).remove();
  }
}

/* ---------- EVENTS CRUD ---------- */
function addEvent(){
  if(!imageUrl.value) return;
  db.ref("events").push({ imageUrl: imageUrl.value });
  imageUrl.value = "";
}

function loadEvents(){
  db.ref("events").on("value", snap => {
    const list = document.getElementById("eventList");
    list.innerHTML = "";
    snap.forEach(c=>{
      list.innerHTML += `
        <div class="item">
          <img src="${c.val().imageUrl}">
          <div class="actions">
            <button class="edit"
              onclick="editEvent('${c.key}','${c.val().imageUrl}')">Edit</button>
            <button class="delete"
              onclick="deleteEvent('${c.key}')">Delete</button>
          </div>
        </div>`;
    });
  });
}

function editEvent(id, url){
  const newUrl = prompt("Update image URL", url);
  if(newUrl){
    db.ref("events/" + id).update({ imageUrl: newUrl });
  }
}

function deleteEvent(id){
  if(confirm("Delete this event image?")){
    db.ref("events/" + id).remove();
  }
}

/* ---------- MEDIA IMAGES CRUD ---------- */
function addMediaImage(){
  if(!mediaUrl.value) return;
  db.ref("gallery").push({ url: mediaUrl.value });
  mediaUrl.value = "";
}

function loadMediaImages(){
  db.ref("gallery").on("value", snap => {
    const list = document.getElementById("mediaList");
    list.innerHTML = "";
    snap.forEach(c=>{
      list.innerHTML += `
        <div class="item">
          <img src="${c.val().url}">
          <div class="actions">
            <button class="edit"
              onclick="editMedia('${c.key}','${c.val().url}')">Edit</button>
            <button class="delete"
              onclick="deleteMedia('${c.key}')">Delete</button>
          </div>
        </div>`;
    });
  });
}

function editMedia(id, url){
  const newUrl = prompt("Update media image URL", url);
  if(newUrl){
    db.ref("gallery/" + id).update({ url: newUrl });
  }
}

function deleteMedia(id){
  if(confirm("Delete this media image?")){
    db.ref("gallery/" + id).remove();
  }
}
// Refresh preview manually
function refreshPreview(){
  const iframe = document.getElementById('livePreview');
  iframe.src = iframe.src; // reload the iframe
}

// Optional: Auto-refresh every 60 seconds
setInterval(() => {
  const iframe = document.getElementById('livePreview');
  iframe.src = iframe.src;
}, 60000);
</script>
<!-- ================= RESPONSIVE ADMIN PANEL SCRIPT ================= -->
<style>
/* Make all panels responsive */
.panel {
  max-width: 1000px;
  width: 95%;
  margin: 20px auto;
  padding: 20px;
  box-sizing: border-box;
}

/* Input, textarea, button responsiveness */
input, textarea, button {
  width: 100%;
  font-size: 16px;
  margin-top: 10px;
  padding: 10px;
  box-sizing: border-box;
}

/* Make item containers flexible */
.item {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.item img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
}

/* Actions buttons wrap on smaller screens */
.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

/* Responsive headings */
.panel h2, .panel h3 {
  font-size: 1.4rem;
}

/* Scrollable lists on mobile */
#newsList, #eventList, #mediaList {
  max-height: 500px;
  overflow-y: auto;
  padding-right: 5px;
}

/* Responsive tweaks */
@media (max-width: 768px) {
  .panel {
    padding: 15px;
  }
  .panel h2, .panel h3 {
    font-size: 1.2rem;
  }
}

@media (max-width: 480px) {
  .panel {
    padding: 10px;
  }
  .panel h2, .panel h3 {
    font-size: 1rem;
  }
  .actions button {
    flex: 1 1 100%;
  }
}
</style>

<script>
/* ================= OPTIONAL: Auto adjust iframe previews ================= */
function adjustIframeHeight(iframeId) {
  const iframe = document.getElementById(iframeId);
  if (!iframe) return;
  try {
    iframe.style.height = iframe.contentWindow.document.body.scrollHeight + 'px';
  } catch(e) {
    // cross-origin iframe; fallback
    iframe.style.height = '600px';
  }
}
</script>
</body>
</html>
